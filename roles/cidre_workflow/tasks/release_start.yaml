---

- name: Git | create release branch
  shell: "git checkout -b {{ cidre.git.branches.release }}/{{ cidre.version.to }}"
  ignore_errors: yes

- name: "Write into {{ cidre.version.file }}"
  tags: ["always", "version_write"]
  block:
  - copy:
      content: "{{ cidre.version.to }}"
      dest: "{{ cidre.version.file }}"
  - shell: |
      git add {{ cidre.version.file }}
      git commit {{ cidre.version.file }} -m "Bump version to {{ cidre.version.to }}"
  when: cidre.version.to != cidre.version.current

- name: Get or create milestone
  when: cidre.project.platform == 'github'
  block:
  - name: create milestone
    community.cidre.platform:
      platform: "{{ cidre.project.platform }}"
      action: create
      context:
        repo: "{{ cidre.project.id }}"
      resource: milestones
      data:
        title: "{{ cidre.version.to }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - debug:
      msg: "milestone created {{ g_milestone.content.html_url }}"

- name: Get or create milestone
  when: cidre.project.platform == 'gitlab'
  block:
  - name: create milestone
    community.cidre.platform:
      platform: "{{ cidre.project.platform }}"
      action: create
      context:
        project: "{{ cidre.project.id }}"
      resource: milestones
      data:
        title: "{{ cidre.version.to }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - debug:
      msg: "milestone created {{ g_milestone.content.web_url }}"
