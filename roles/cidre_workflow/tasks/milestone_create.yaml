---

##
# "project" provider
##
- name: Get or create milestone
  ignore_errors: yes
  block:
  - name: create milestone
    ebuildy.cidre.platform:
      provider: "{{ cidre_provider }}"
      provider_endpoint: "{{ cidre_provider_endpoint }}"
      action: create
      context:
      - repo: "{{ cidre_repo }}"
      resource: milestones
      data:
        title: "{{ ms_version }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - when: cidre_provider == 'github' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.html_url }}"
  - when: cidre_provider == 'gitlab' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.web_url }}"

##
# "issue" provider
##
- when: cidre_issue_provider != cidre_provider and cidre_issue_provider != "jira"
  name: Get or create milestone on issue provider
  ignore_errors: yes
  block:
  - name: create milestone
    ebuildy.cidre.platform:
      provider: "{{ cidre_issue_provider }}"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      action: create
      context:
      - repo: "{{ cidre_repo }}"
      resource: milestones
      data:
        title: "{{ ms_version }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - when: cidre_issue_provider == 'github' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.html_url }}"
  - when: cidre_issue_provider == 'gitlab' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.web_url }}"

- when: cidre_issue_provider == "jira"
  name: Get or create milestone on issue provider
  block:
  - name: create milestone
    ebuildy.cidre.platform:
      provider: "{{ cidre_issue_provider }}"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      action: create
      resource: api/2/version
      data:
        project: "{{ cidre_issue_repo }}"
        name: "{{ cidre_issue_component }}-{{ ms_version }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - debug:
      msg: "milestone created {{ g_milestone.content.self }}"
