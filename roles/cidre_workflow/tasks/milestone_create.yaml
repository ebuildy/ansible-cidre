---

- when: false
  set_fact:
    repo_provider: &repo_provider
      api: "{{ cidre_provider }}"
      api_url: "{{ cidre_provider_endpoint }}"
      #api_token: "{{ cidre_blog_api_token }}"
    issue_provider: &issue_provider
      api: "{{ cidre_issue_provider }}"
      api_url: "{{ cidre_issue_provider_endpoint }}"
      #api_token: "{{ cidre_blog_api_token }}"

##
# "project" provider
##
- name: Get or create milestone
  ignore_errors: yes
  block:
  - name: create milestone
    ebuildy.cidre.api:
      <<: *repo_provider
      action: create
      context:
      - repos: "{{ cidre_repo }}"
      resource: milestones
      data:
        title: "{{ ms_version }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - name: write data holder
    copy:
      dest: "{{ cidre_data_file }}"
      content: "{{ cidre_data | combine({'milestone' : { 'id' : g_milestone.content.id, 'name' : cidre_version }}) | to_yaml }}"
  - when: cidre_provider == 'github' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.html_url }}"
  - when: cidre_provider == 'gitlab' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.web_url }}"

##
# "issue" provider mirror
##
- when: cidre_issue_provider == "jira"
  name: Get or create milestone on issue provider
  block:
  - name: create milestone
    ebuildy.cidre.api:
      <<: *issue_provider
      action: create
      resource: version
      data:
        project: "{{ cidre_issue_repo }}"
        name: "{{ cidre_issue_component }}-{{ ms_version }}"
        description: "See {{ g_milestone.content.web_url }}"
    register: g_milestone
  - name: write data holder
    copy:
      dest: "{{ cidre_data_file }}"
      content: "{{ cidre_data | combine({'milestone_jira' : { 'id' : g_milestone.content.id, 'name' : cidre_version }}) | to_yaml }}"
  - debug:
      msg: "milestone created {{ g_milestone.content.self }}"

- shell: |
    git add {{ cidre_data_file }}
    git commit {{ cidre_data_file }} -m "Create MS {{ ms_version }}"
