---

##
# "project" provider
##
- name: Get or create milestone
  ignore_errors: yes
  block:
  - name: create milestone
    ebuildy.cidre.platform:
      provider: "{{ cidre_provider }}"
      provider_endpoint: "{{ cidre_provider_endpoint }}"
      action: create
      context:
      - repos: "{{ cidre_repo }}"
      resource: milestones
      data:
        title: "{{ ms_version }}"
        description: "Generated by cidre.io"
    register: g_milestone
  - when: cidre_provider == 'github' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.html_url }}"
  - when: cidre_provider == 'gitlab' and g_milestone.content is defined
    debug:
      msg: "milestone created {{ g_milestone.content.web_url }}"

##
# "issue" provider mirror
##
- when: cidre_issue_provider == "jira"
  name: Get or create milestone on issue provider
  block:
  - name: create milestone
    ebuildy.cidre.platform:
      provider: "jira"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      action: create
      resource: version
      data:
        project: "{{ cidre_issue_repo }}"
        name: "{{ cidre_issue_component }}-{{ ms_version }}"
        description: "See {{ g_milestone.content.web_url }}"
    register: g_milestone
  - ebuildy.cidre.platform:
      provider: "jira"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      action: create
      resource: issue
      data:
        fields:
          project:
            key: "{{ cidre_issue_repo }}"
          summary: "Milestone {{ cidre_issue_component }} {{ cidre_version }}"
          description: "Issue to follow milestone {{ cidre_version }} - mirrored by {{ g_milestone.content.web_url | default(g_milestone.content.html_url) | default('') }}"
          components:
          - name: "{{ cidre_issue_component }}"
          fixVersions:
          - name: "{{ cidre_issue_component }}-{{ cidre_version }}"
          issuetype:
            name: Task
    register: g_issue
  - debug:
      msg: "milestone created {{ g_milestone.content.self }} - issue {{ cidre_issue_provider_front }}/browse/{{ g_issue.content.key }}"
