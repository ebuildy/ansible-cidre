---

- name: Check | git commits
  block:
  - shell: "git status --porcelain"
    register: git_status
  - fail:
      msg: "Please commit all changes: {{ git_status.stdout }}"
    when: git_status.stdout != ""

- set_fact:
    git_branch: "{{ cidre.git.branches.release }}/{{ cidre.version.current }}"

#- name: Check | git branch
#  tags: ["always"]
#  block:
#  - shell: "git branch --show-current"
#    register: git_branch
#  - fail:
#      msg: "You are not in a release ({{ git.branches.release }}/*) branch!"
#    when: git_branch.stdout | regex_search("^" ~ git.branches.release ~ "\/(.*)$")

# Check branch exist (or not, this not required)
- shell: "git rev-parse --verify --quiet {{ git_branch }} || true"
  register: shell_git_branch

# Check tag exist
- shell: "git rev-parse --verify --quiet {{ cidre.version.current }} || true"
  register: shell_git_tag

- name: Merge branch into main
  when: shell_git_branch.stdout != ""
  shell: |
    git switch {{ cidre.git.branches.main }}
    git merge {{ git_branch }}

- name: Merge main branch into develop
  when: shell_git_branch.stdout != ""
  shell: |
    git switch {{ cidre.git.branches.develop }}
    git merge {{ git_branch }}

- name: Create git tag from main branch
  when: shell_git_tag.stdout == ""
  shell: |
    git switch {{ cidre.git.branches.main }}
    git tag -a {{ cidre.version.current }} -m "{{ cidre.version.current }}: {{ cidre_milestone.web_url }}"

- name: git push
  shell: "git push origin {{ item }}"
  with_items:
  - "{{ cidre.git.branches.develop }}"
  - "{{ cidre.git.branches.main }}"
  - "{{ cidre.version.current }}"

- name: Create Github release
  when: cidre.project.platform == "github"
  block:
  - community.cidre.platform:
      platform: "{{ cidre.project.platform }}"
      context:
        repo: "{{ cidre.project.id }}"
      action: create
      resource: releases
      data:
        name: "{{ cidre.version.current }}"
        tag_name: "{{ cidre.version.current }}"
        description: "{{ cidre_milestone.description }}"
    register: g_release
  - debug:
      msg: "Release created: {{ g_release.content.html_url }}"

- name: Create Gitlab release
  when: cidre.project.platform == "gitlab"
  block:
  - community.cidre.platform:
      platform: "{{ cidre.project.platform }}"
      context:
        repo: "{{ cidre.project.id }}"
      action: create
      resource: releases
      data:
        name: "{{ cidre.version.current }}"
        tag_name: "{{ cidre.version.current }}"
        description: "{{ cidre_milestone.description }}"
        milestone: "{{ cidre_milestone.id }}"
    register: g_release
  - debug:
      msg: "Release created: {{ g_release.content.web_url }}"

- name: Delete local and remote release branch
  shell: |
    git branch -D {{ git_branch }}
    git push -d origin {{ git_branch }}
