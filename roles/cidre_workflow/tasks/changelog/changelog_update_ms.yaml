---

- when: cidre_issue_provider == "jira"
  set_fact:
    search_query:
      provider: "jira"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      resource: search
      query_string:
        jql: "project={{cidre_issue_repo}} AND fixVersion={{ cidre_issue_component }}-{{ cidre_milestone.title }}"

- when: cidre_issue_provider != "jira"
  set_fact:
    search_query:
      provider: "{{ cidre_issue_provider }}"
      provider_endpoint: "{{ cidre_issue_provider_endpoint }}"
      resource: issues
      context:
      - repos: "{{ cidre_repo }}"
      query_string:
        milestone: "{{ (cidre_provider == 'github') | ternary(cidre_milestone.id, cidre_milestone.title) }}"
        state: all

- name: "{{ cidre_issue_provider }} > List issues"
  ebuildy.cidre.api: "{{ search_query }}"
  register: platform_issues

- name: Git change log
  shell: |
    if [ $(git tag | wc -l) -gt 0 ]
    then
      if [ $(git tag -l "{{ cidre_version }}") ]; then
        # current version already deployed
        git log {{ cidre_version }}^..{{ cidre_version }} --pretty='format:[%ci] @%aN (%h) %s'
      else
        git log {{ cidre_version }}..HEAD --pretty='format:[%ci] @%aN (%h) %s'
      fi
    else
      git log --pretty='format:[%ci] @%aN (%h) %s'
    fi

    exit 0
  register: git_changes

- name: Build content
  set_fact:
    milestone_content: "{{ lookup('template', cidre_issue_provider + '_milestone_body.md.j2') }}"

- name: "{{ cidre_provider }} > Update milestone"
  ebuildy.cidre.api:
    provider: "{{ cidre_provider }}"
    provider_endpoint: "{{ cidre_provider_endpoint }}"
    action: update
    context:
    - repos: "{{ cidre_repo }}"
    - milestones: "{{ cidre_milestone.id }}"
    data:
      description: "{{ milestone_content }}"

- when: cidre_blog_provider == "confluence"
  name: Confluence
  include_tasks:
    file: "confluence_write_page.yaml"

- debug:
    msg: "Milestone updated: {{ cidre_milestone.web_url }}"
