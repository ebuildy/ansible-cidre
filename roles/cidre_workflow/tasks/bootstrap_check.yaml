---

- name: Check git is clean
  tags:
  - never
  - cidre_ms_open
  - cidre_ms_close
  - cidre_changelog
  - cidre_bump_patch
  - cidre_bump_minor
  - cidre_bump_major
  - bootstrap_check
  block:
  - shell: "git status --porcelain"
    register: git_status
  - fail:
      msg: "Please clean git status: {{ git_status.stdout }}"
    when: git_status.stdout != ""

- name: Check platform API authorized
  tags:
  - never
  - cidre_ms_open
  - cidre_ms_close
  - cidre_ms_issues_close
  - cidre_changelog
  - cidre_bump_patch
  - cidre_bump_minor
  - cidre_bump_major
  - cidre_info
  - cidre_status
  - cidre_release_create
  - cidre_status_create
  - bootstrap_check
  block:
  - include_tasks:
      file: "get_user.yaml"
    vars:
      _cidre_provider: "{{ cidre_provider}}"
      _cidre_provider_endpoint: "{{ cidre_provider_endpoint }}"
  - when: cidre_issue_provider != cidre_provider
    include_tasks:
      file: "get_user.yaml"
    vars:
      _cidre_provider: "{{ cidre_issue_provider}}"
      _cidre_provider_endpoint: "{{ cidre_issue_provider_endpoint }}"

- name: Get current milestone
  tags:
  - never
  - cidre_init
  - cidre_info
  - cidre_status
  - cidre_ms_close
  - cidre_changelog
  - cidre_issue_create
  - cidre_ms_issues_close
  block:
  - set_fact:
      cidre_milestone: "{{ lookup('ebuildy.cidre.milestone', cidre_version, repo=cidre_repo, provider=cidre_provider, provider_endpoint=cidre_provider_endpoint) }}"
  #- debug:
  #    var: cidre_milestone
  - when: cidre_milestone.id is not defined
    fail:
      msg: "Milestone {{ cidre_version }} not found! You must create it manualy."
